@{
    @using Microsoft.AspNetCore.Identity;
    @using Audiology.Data.Models;
    @model IEnumerable<Audiology.Web.ViewModels.Songs.SongListViewModel>
    this.ViewData["Title"] = "All Songs";
    @inject UserManager<ApplicationUser> UserManager
    string userId = this.UserManager.GetUserId(this.User);
}

<h1 class="text-center">All Songs</h1>

<style>
    .playerContainer {
        margin: 75px auto;
        max-width: 500px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    }
</style>

<div class="row">
    @foreach (var song in Model)
    {
        <div class="col-md-4">
            <div class="playerContainer" style="width: 18rem;">
                <img src="@song.AlbumCoverUrl" style="width: 18rem; height: 10rem;" alt="Image not found" />
                <h6 class="text-center">@song.Name.Replace(".mp3", "")</h6>
                <h5 class="text-center">@this.User.Identity.Name</h5>
                <div class="text-muted small ml-3">
                    <form id="votesForm" method="post"></form>
                    <a href="#" onclick="favourite(@userId,@song.Id,9)"><i class="fas fa-heart" style="padding-left: 0px;"></i></a>
                    <div id="favouritesCount">@song.FavouritesCount</div>
                </div>
                <audio id="player" controls>
                    <source src="~/Songs//@this.User.Identity.Name/@song.Name" type="audio/mp3">
                </audio>
            </div>
        </div>
    }
</div>

@section Scripts{
    <script src="https://cdn.plyr.io/3.5.10/plyr.js"></script>
    <script>
        const player = new Plyr('audio', {});

        // Expose player so it can be used from the console
        window.player = player;
    </script>

    <script>
        function favourite(userId, songId, albumId) {

            var token = $("#votesForm input[name=__RequestVerificationToken]").val();
            var json = { "userId": userId, "songId": songId, "albumId": albumId };
            console.log(json);
            $.ajax({
                url: "/api/favourites",
                type: "POST",
                data: JSON.stringify(json),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                headers: { 'X-CSRF-TOKEN': token },
                success: function () {
                    console.log(json);
                }
            });
        }

    </script>
}